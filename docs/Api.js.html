<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Api.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Api.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* global atob, btoa */

const { capitalizeWord, verifyRequired } = require('@bowtie/utils')

const defaults = {
  root: null,
  stage: null,
  prefix: null,
  version: null,
  verbose: false,
  secureOnly: true,
  authorization: 'None',
  defaultOptions: {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    }
  }
}

/**
 * Auth types
 *  - Basic
 *  - Token
 */

/**
 * Api class to handle all interactions with backend
 */
class Api {
  /**
   * Constructor for an Api object
   * @constructor
   * @param {object} settings - Settings to create api instance
   * @param {string} settings.root - Root url/domain for this API
   * @param {string} settings.stage - API stage (useful for API's built on serverless)
   * @param {string} settings.prefix - API prefix (i.e. "api")
   * @param {string} settings.version - API version (i.e. "v1")
   * @param {boolean} [settings.verbose=false] - Flag to enable debug logs
   * @param {boolean} [settings.secureOnly=true] - Require HTTPS API
   * @param {string} [settings.authorization='None'] - Auth type
   * @param {object} settings.defaultOptions
   * @param {string} [settings.defaultOptions.method='GET']
   * @param {object} settings.defaultOptions.headers
   * @param {string} [settings.defaultOptions.headers['Content-Type']='application/json']
   */
  constructor (settings) {
    this.settings = Object.assign({}, defaults, settings)

    // Validate this API instance
    this.validate()

    this.init()

    // Sanitize all API variables for this API instance
    this.sanitize()
  }

  init () {
    this.isNode = require('detect-node')

    if (this.isNode) {
      this.fetch = require('node-fetch')
    } else if (window &amp;&amp; window.fetch &amp;&amp; typeof window.fetch === 'function') {
      this.fetch = window.fetch.bind(window)
    } else {
      throw new Error('Unable to load fetch')
    }

    // Root domain for the API (MUST be over HTTPS)
    this.root = this.settings.root

    // API stage (dev only for now)
    this.stage = this.settings.stage

    // API path prefix (shouldn't change)
    this.prefix = this.settings.prefix

    // API version (in case future versions are released, this is easy to change)
    this.version = this.settings.version
  }

  /**
   * Sanitize all API variables for this API instance
   */
  sanitize () {
    // Split the root member variable on '://' (to ensure protocol exists or we can add it)
    const rootParts = this.root.split('://')

    // If more than 1 part, then protocol is specified
    if (rootParts.length > 1) {
      // Ensure specified protocol is HTTPS
      if (rootParts[0] !== 'https') {
        if (this.settings.secureOnly) {
          throw new Error('API Base URL must use HTTPS')
        } else {
          console.warn('API Base URL should use HTTPS for security')
        }
      }
    } else {
      // No protocol specified in "this.root", so prepend "https://"
      this.root = `https://${this.root}`
    }

    // Trim trailing slash from root member variable (if present)
    if (this.root.substr(-1) === '/') {
      this.root = this.root.substr(0, this.root.length - 1)
    }

    // Remove all slashes from other member variables (stage, prefix, version, etc)
    if (this.stage) this.stage = this.stage.replace(/\//g, '')
    if (this.prefix) this.prefix = this.prefix.replace(/\//g, '')
    if (this.version) this.version = this.version.replace(/\//g, '')

    this.settings.authorization = capitalizeWord(this.settings.authorization)
  }

  hasValidToken () {
    const token = this.varOrFn(this.token) || null

    return token &amp;&amp; token.trim() !== ''
  }

  isAuthorized () {
    return (this.settings.authorization !== 'None' &amp;&amp; this.hasValidToken())
  }

  base64encode (str) {
    if (this.isNode) {
      return Buffer.from(str).toString('base64')
    } else if (typeof btoa === 'function') {
      return btoa(str)
    }
  }

  base64decode (b64, format = 'utf8') {
    if (this.isNode) {
      return Buffer.from(b64, 'base64').toString(format)
    } else if (typeof atob === 'function') {
      return atob(b64)
    }
  }

  varOrFn (arg) {
    if (typeof arg === 'function') {
      return arg()
    } else {
      return arg
    }
  }

  authorize (args) {
    if (args.token) {
      this.token = args.token
    } else if (this.settings.authorization === 'Basic' &amp;&amp; args.username &amp;&amp; args.password) {
      this.token = () => {
        return this.base64encode(`${this.varOrFn(args.username)}:${this.varOrFn(args.password)}`)
      }
    } else {
      throw new Error('Invalid args to authorize()')
    }
  }

  /**
   * Validate this API instance
   */
  validate () {
    const schema = {
      root: 'string',
      verbose: 'boolean',
      secureOnly: 'boolean',
      authorization: 'string',
      defaultOptions: {
        method: 'string',
        headers: 'object'
      }
    }

    verifyRequired(this.settings, schema)
  }

  /**
   * Construct the base URL for this API (using other member variables)
   */
  baseUrl () {
    let baseUrl = this.root

    if (this.stage) baseUrl += '/' + this.stage
    if (this.prefix) baseUrl += '/' + this.prefix
    if (this.version) baseUrl += '/' + this.version

    return `${baseUrl}/`
  }

  /**
   * Build a request URL for a specific path
   */
  buildUrl (path) {
    // If the path begins with a slash, remove the slash (since the baseUrl function ends with slash already)
    if (path.substr(0, 1) === '/') {
      path = path.substr(1)
    }

    // Return the full URL for the specified path
    return this.baseUrl() + path
  }

  /**
   * Generic request execution method
   *    For a GET request, only the "path" parameter is required
   */
  callRoute ({ path, options = {}, params = {} }) {
    // Return a promise so we can handle async requests in the components
    return new Promise(
      // Promise format using resolve and reject functions
      (resolve, reject) => {
        // Debug
        this._debug('Calling route:', path)

        // Merge options provided to this method with the default options for this API instance
        const callOptions = Object.assign({}, this.settings.defaultOptions, options)

        if (this.isAuthorized()) {
          callOptions.headers.Authorization = `${this.settings.authorization} ${this.varOrFn(this.token)}`
        }

        this._debug('callOptions: ', callOptions)

        // Call fetch for the full request URL (using buildUrl function and merged callOptions object)
        this.fetch(this.buildUrl(path), callOptions)
          // Convert response body to JSON (should trigger catch if fails)
          .then(response => {
            // this._debug(response);

            return response.json()
          })

          // After converting to JSON, resolve the callRoute() Promise with the returned data
          .then(data => {
            // Debug
            this._debug('Response data', data)

            // Resolve promise
            resolve(data)
          })

          // Catch fetch error and reject the Promise
          .catch(reject)
      }
    )
  }

  /**
   * Helper for simple GET requests (only need to call "api.get('something')")
   */
  get (path) {
    // Return the result (Promise) of callRoute() with the provided path
    return this.callRoute({ path })
  }

  post (path, body = {}) {
    const options = {
      method: 'POST',
      body: JSON.stringify(body)
    }

    // Return the result (Promise) of callRoute() with the provided path
    return this.callRoute({ path, options })
  }

  put (path, body = {}) {
    const options = {
      method: 'PUT',
      body: JSON.stringify(body)
    }

    // Return the result (Promise) of callRoute() with the provided path
    return this.callRoute({ path, options })
  }

  delete (path, body = {}) {
    const options = {
      method: 'DELETE'
    }

    // Return the result (Promise) of callRoute() with the provided path
    return this.callRoute({ path, options })
  }

  _debug () {
    if (this.settings.verbose) {
      console.log(...arguments)
    }
  }
}

module.exports = Api
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Api.html">Api</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Feb 08 2018 23:28:43 GMT-0700 (MST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
